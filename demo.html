<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Backlot demo</title>

    <style type="text/css">
      body{
        background-color: #050505;
        color: #BEBEBE;
        font-family: arial, sans-serif;
        max-width: 1280px;
        margin: 0px auto;
        padding: 1em;
      }
      #fps_meter{
        position: absolute;
        bottom: 1.2em;
        left: 1.1em;
        width: 200px;
        margin: 0px auto;
        min-height: 3em;
      }
      #game_canvas{
        border: 1px solid #333;
        background-color: #000;
        cursor: none;
        display: block;
        margin: 0px auto;
      }
      #container{
        width: 1280px;
        margin: 0px auto;
        position: relative;
      }
      input {
        padding: 0.1em;
        font-size: 1.2em;
      }
    </style>
  </head>

  <body>
    <div id="container">
      <div id="fps_meter"></div>
      <div id="game">
        <canvas id="game_canvas" width="1280" height="720"></canvas>
      </div>
    </div>

    <script type="text/javascript" src="src/libs/matter.js"></script>
    <script type="text/javascript" src="src/libs/matter_collision_events.js"></script>
    <script type="text/javascript" src="src/util.js"></script>
    <script type="text/javascript" src="src/util/vector.js"></script>
    <script type="text/javascript" src="src/meter.js"></script>
    <script type="text/javascript" src="src/cursor.js"></script>
    <script type="text/javascript" src="src/viewport.js"></script>
    <script type="text/javascript" src="src/engine.js"></script>
    <script type="text/javascript" src="src/world/layer.js"></script>
    <script type="text/javascript" src="src/world.js"></script>
    <script type="text/javascript" src="src/asset_depot.js"></script>
    <script type="text/javascript" src="src/entity.js"></script>
    <script type="text/javascript" src="src/entities/sprite.js"></script>
    <script type="text/javascript" src="src/entities/animation.js"></script>
    <script type="text/javascript" src="src/game.js"></script>

    <script type="text/javascript">
      const game = new Game("game_canvas");
      game.set_fps_meter("fps_meter");

      class Floor extends Entity {
        constructor(){
          super(0, 340, 1280, 20);
          this.physics = Matter.Bodies.rectangle(0, 340, 1280, 20, {isStatic: true});
          this.physics.entity = this;
          this.is_floor = true;
          this.physics.onCollide((pair) => this.collide(pair));
        }
        collide(pair){          
          if(pair.bodyA.entity.is_enemy || pair.bodyB.entity.is_enemy){
            let enemy = pair.bodyA.entity.is_enemy ? pair.bodyA.entity : pair.bodyB.entity;
            let floor = pair.bodyA.entity.is_enemy ? pair.bodyB.entity : pair.bodyA.entity;
            game.scene.restart();
          }
        }
      }

      class Enemy extends Entity {
        constructor(x, y){
          super(x, y, 60, 30);
          this.physics = Matter.Bodies.rectangle(x, y, 60, 30, {frictionAir: 0});
          Matter.Body.setVelocity(this.physics, {x: 0, y: 1});
          this.physics.entity = this;
          this.is_enemy = true;
          this.damage = 0;
        }
        update(dt){
          super.update(dt);
          this.x = this.physics.position.x;
          this.y = this.physics.position.y;
          this.angle = this.physics.angle;
          if(this.damage >= 2) this.dead = true;
        }
      }

      class Bullet extends Entity {
        constructor(x, y){
          super(x, y, 21, 21);
          this.age = 0;
          this.physics = Matter.Bodies.rectangle(x, y, 21, 21, {frictionAir: 0});
          Matter.Body.setVelocity(this.physics, {x: 0, y: -29});
          this.physics.onCollide((pair) => this.collide(pair));
          this.physics.entity = this;
          this.is_bullet = true;
        }
        update(dt){
          super.update(dt);
          this.x = this.physics.position.x;
          this.y = this.physics.position.y;
          this.angle = this.physics.angle;
          this.age += dt;
          if(this.age >= 1){
            this.dead = true;
          }
        }
        collide(pair){
          if(pair.bodyA.entity.is_enemy || pair.bodyB.entity.is_enemy){
            let enemy = pair.bodyA.entity.is_enemy ? pair.bodyA.entity : pair.bodyB.entity;
            let bullet = pair.bodyA.entity.is_enemy ? pair.bodyB.entity : pair.bodyA.entity;
            enemy.damage += 1;
            bullet.dead = true;
          }
        }
      }

      class Player extends Entity {
        constructor(){
          super(0, 290, 100, 50);
          this.physics = Matter.Bodies.rectangle(0, 290, 100, 50, {isStatic: true});
          this.left = false;
          this.right = false;
          this.shooting = false;
          this.time_since_last_shot = 0;
          this.physics.entity = this;
          this.is_player = true;
        }
        update(dt){
          super.update(dt);
          if(this.left)
            this.x -= dt * 300;
          if(this.right)
            this.x += dt * 300;
          Matter.Body.setPosition(this.physics, {x: this.x, y: this.y});
          if(this.shooting){
            if(this.time_since_last_shot == 0){              
              game.scene.add(new Bullet(this.x, this.y));
            }
            this.time_since_last_shot += dt;
            if(this.time_since_last_shot >= 0.05){
              this.time_since_last_shot = 0;
            }
          }
        }
      }
      game.set_scene({
        world: new World(1280, 720),
        setup: function(){
          this.restart();
        },
        restart: function(){
          this.world.layers = [];
          for(var i = 0; i < 9; i++){
            for(var j = 0; j < 9; j++){
              this.add(new Enemy(300-i*75, 0-j*45));
            }
          }
          this.player = new Player();
          this.add(this.player);
          this.floor = new Floor();
          this.add(this.floor);
        },
        handle_key(event, pressed){
          if(event.key === "ArrowLeft")
            this.player.left = pressed;
          if(event.key === "ArrowRight")
            this.player.right = pressed;
          if(event.key === " ")
            this.player.shooting = pressed;
        },
      });
      game.run();
    </script>

  </body>
</html>
